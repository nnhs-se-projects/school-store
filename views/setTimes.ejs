<%- include('include/_header') %>

<link rel="stylesheet" href="/css/times.css" />

<main>
  <div class="wrapper">
    <h1>Set Times</h1>
    <div class="add-time-section">
      <h2>Add New Time</h2>
      <form action="/setTimes" method="POST" class="add-time-form">
        <label for="date">Select Date:</label>
        <input type="date" id="date" name="date" required><br>
        
        <label for="openTime">Open Time:</label>
        <input type="time" id="openTime" name="openTime" required><br>
        
        <label for="closeTime">Close Time:</label>
        <input type="time" id="closeTime" name="closeTime" required><br>
        
        <button type="submit">Save Time</button>
      </form>
    </div>
    
    <h2 class="store-hours-h2">Store Hours for Next Two Weeks</h2>
    <div class="calendar-nav">
      <button id="prev-week" class="nav-arrow">◀</button>
      <button id="next-week" class="nav-arrow">▶</button>
    </div>
    <%
    const today = new Date();
    const offset = parseInt(query.offset || 0);
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay() + (offset * 14)); // Sunday + offset
    const endDate = new Date(startOfWeek);
    endDate.setDate(startOfWeek.getDate() + 13); // Two weeks
    
    const timesMap = {};
    times.forEach(time => {
      const dateStr = time.date.toISOString().split('T')[0];
      timesMap[dateStr] = time.times;
    });
    %>
    <table class="calendar">
      <thead>
        <tr>
          <th>Sun</th>
          <th>Mon</th>
          <th>Tue</th>
          <th>Wed</th>
          <th>Thu</th>
          <th>Fri</th>
          <th>Sat</th>
        </tr>
      </thead>
      <tbody>
        <% for (let week = 0; week < 2; week++) { %>
          <tr>
            <% for (let day = 0; day < 7; day++) { %>
              <% 
              const currentDate = new Date(startOfWeek);
              currentDate.setDate(startOfWeek.getDate() + week * 7 + day);
              const dateStr = currentDate.toISOString().split('T')[0];
              const dayTimes = timesMap[dateStr];
              %>
              <td class="day">
                <div class="date"><%= currentDate.getDate() %></div>
                <% if (dayTimes && dayTimes.length > 0) { %>
                  <ul>
                    <% dayTimes.forEach((slot, index) => { %>
                      <li><%= slot.openTime %> - <%= slot.closeTime %>
                        <div class="edit-popup">
                          <form action="/editTime" method="POST">
                            <input type="hidden" name="date" value="<%= dateStr %>">
                            <input type="hidden" name="index" value="<%= index %>">
                            <label>Open: <input type="time" name="openTime" value="<%= slot.openTime %>" required></label><br>
                            <label>Close: <input type="time" name="closeTime" value="<%= slot.closeTime %>" required></label><br>
                            <div class="button-group">
                              <button type="submit" name="action" value="save">Save</button>
                              <button type="submit" name="action" value="delete">Delete</button>
                            </div>
                          </form>
                        </div>
                      </li>
                    <% }); %>
                  </ul>
                <% } else { %>
                  <p>Closed</p>
                <% } %>
              </td>
            <% } %>
          </tr>
        <% } %>
      </tbody>
    </table>
    <script>
      const currentOffset = <%= offset %>;
      const prevBtn = document.getElementById('prev-week');
      const nextBtn = document.getElementById('next-week');
      
      // Disable previous button if offset is already -1
      if (currentOffset <= -1) {
        prevBtn.disabled = true;
      }
      
      // Disable next button if offset is already 1
      if (currentOffset >= 1) {
        nextBtn.disabled = true;
      }
      
      prevBtn.addEventListener('click', () => {
        if (currentOffset > -1) {
          window.location.href = '/setTimes?offset=' + (currentOffset - 1);
        }
      });
      
      nextBtn.addEventListener('click', () => {
        if (currentOffset < 1) {
          window.location.href = '/setTimes?offset=' + (currentOffset + 1);
        }
      });
    </script>
  </div>
</main>

<%- include('include/_footer') %>
